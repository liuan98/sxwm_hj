(my["webpackJsonp"]=my["webpackJsonp"]||[]).push([["pages/order-submit/order-submit"],{"39fe":function(t,e,r){"use strict";r.r(e);var i=r("ff12"),a=r("c0e3");for(var o in a)"default"!==o&&function(t){r.d(e,t,function(){return a[t]})}(o);r("42bc");var s=r("2877"),n=Object(s["a"])(a["default"],i["a"],i["b"],!1,null,"ee1dc79e",null);e["default"]=n.exports},"42bc":function(t,e,r){"use strict";var i=r("ad23"),a=r.n(i);a.a},"718c":function(t,e,r){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=r("2f62");function a(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)}return r}function o(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?a(r,!0).forEach(function(e){s(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):a(r).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function s(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var n=function(){return r.e("components/basic-component/app-radio/app-radio").then(r.bind(null,"3ac8"))},l=function(){return r.e("pages/order-submit/app-order-submit-row").then(r.bind(null,"8f1f"))},c=function(){return r.e("components/page-component/app-diy-form/app-diy-form").then(r.bind(null,"7d93"))},u={name:"order-submit",components:{AppDiyForm:c,AppRadio:n,AppOrderSubmitRow:l},data:function(){return{totalTitle:"合计",check:!1,previewData:null,getLocationFail:!1,previewUrl:null,submitUrl:null,plugin:null,orderPageUrl:null,submitLock:!1,getPayDataTimer:null,userTheme:null,payDataUrl:null,showPayResult:!0,payCancelUrl:null}},computed:o({},(0,i.mapState)({appImg:function(t){return t.mallConfig.__wxapp_img}}),{theme:function(){return this.userTheme?this.userTheme:this.$store.state.mallConfig.theme}}),onLoad:function(t){var e=this;this.submitLock||(this.setFormData(t),this.$event.on(this.$const.EVENT_USER_LOGIN).then(function(){e.loadPreviewData()}))},onShow:function(){this.submitLock||this.loadPreviewData()},onHide:function(){console.log("onHide")},onUnload:function(){console.log("onUnload"),this.getPayDataTimer&&clearTimeout(this.getPayDataTimer)},watch:{"previewData.address.name":{handler:function(){this.changeZitiAddress()}},"previewData.address.mobile":{handler:function(){this.changeZitiAddress()}}},methods:{setParams:function(t){t.total_title&&(this.totalTitle=t.total_title)},handleOrderFormInput:function(t,e){var r=[];for(var i in t)r[i]={key:t[i].key,label:t[i].name,value:t[i].value,required:t[i].is_required};var a=this.$store.state.orderSubmit.formData;a.list[e].order_form=r,this.$store.commit("orderSubmit/mutSetFormData",a)},handleOrderFormValidate:function(t,e){console.log("handleOrderFormValidate:",t,e);var r=this.$store.state.orderSubmit.formData;r.list[e].order_form_validate_result=t,this.$store.commit("orderSubmit/mutSetFormData",r)},setFormData:function(t){this.previewUrl=decodeURIComponent(t.preview_url||this.$api.order.preview),this.submitUrl=decodeURIComponent(t.submit_url||this.$api.order.submit),this.plugin=t.plugin||null,console.log(t.plugin),this.orderPageUrl=decodeURIComponent(t.order_page_url||"/pages/order/index/index?status=0"),this.userTheme=t.theme||null,this.payDataUrl=decodeURIComponent(t.pay_data_url||this.$api.order.pay_data),this.payCancelUrl=t.pay_cancel_url?decodeURIComponent(t.pay_cancel_url):null,this.showPayResult=t.show_pay_result||!0,"true"===this.showPayResult&&(this.showPayResult=!0),"false"===this.showPayResult&&(this.showPayResult=!1);var e=JSON.parse(t.mch_list);for(var r in e)for(var i in e[r].distance=0,e[r].remark="",e[r].order_form=[],e[r].use_integral=0,e[r].user_coupon_id=0,e[r].goods_list)e[r].goods_list[i].cart_id=e[r].goods_list[i].cart_id||0;this.$store.commit("orderSubmit/mutSetFormData",{list:e,address_id:0})},loadPreviewData:function(){var e=this;t.showLoading({mask:!0,title:"加载中"}),this.$request({url:this.previewUrl,method:"post",data:{form_data:JSON.stringify(this.$store.state.orderSubmit.formData)}}).then(function(r){t.hideLoading(),0===r.code?(r.data.allZiti&&!r.data.address&&(r.data.address={name:"",mobile:""}),e.previewData=r.data,e.setDiyFormScrollStatus(),e.checkCouponError(),e.updateStoreDistance()):t.showModal({title:"提示",content:r.msg,showCancel:!1,success:function(){t.navigateBack()}})}).catch(function(){t.hideLoading()})},navigateAddress:function(){var e="/pages/order-submit/address-pick";e+="?hasCity="+this.previewData.hasCity,t.navigateTo({url:e})},navigateStore:function(e){if(0==this.previewData.mch_list[e].mch.id){var r="";"booking"===this.plugin&&(r=this.previewData.mch_list[0].goods_list[0].id);var i=this.plugin||"";t.navigateTo({url:"/pages/order-submit/store-pick?mchIndex=".concat(e,"&plugin=").concat(i,"&firstGoodsId=").concat(r)})}},navigateCoupon:function(e){t.navigateTo({url:"/pages/order-submit/coupon-pick?mchIndex=".concat(e)})},changeZitiAddress:function(){var t=this.$store.state.orderSubmit.formData;t.address={name:this.previewData.address.name,mobile:this.previewData.address.mobile},this.$store.commit("orderSubmit/mutSetFormData",t)},changeSendType:function(t,e){if(this.previewData.mch_list[t].delivery.send_type!=e){var r=this.$store.state.orderSubmit.formData;r.list[t].send_type=e,this.$store.commit("orderSubmit/mutSetFormData",r),this.previewData.mch_list[t].delivery.send_type=e,this.loadPreviewData()}},updateStoreDistance:function(){var e=this;this.previewData&&(this.previewData.has_ziti||"booking"==this.plugin)&&t.getLocation({success:function(t){for(var r in e.previewData.mch_list)if(e.previewData.mch_list[r].store&&(!e.previewData.mch_list[r].store.distance||"-m"==e.previewData.mch_list[r].store.distance)){var i=e.$utils.earthDistance({lat:t.latitude,lng:t.longitude},{lat:e.previewData.mch_list[r].store.latitude,lng:e.previewData.mch_list[r].store.longitude}),a="-m";a=i>1e3?(i/1e3).toFixed(2)+"km":i.toFixed(0)+"m",e.previewData.mch_list[r].store.distance=a}},fail:function(){e.getLocationFail=!0}})},openLocationSetting:function(){this.getLocationFail=!1,t.openSetting({})},showIntegralTip:function(){t.showModal({title:"积分抵扣说明",content:this.$store.state.mallConfig.mall.setting.member_integral_rule,showCancel:!1})},changeIntegral:function(t){var e=this.$store.state.orderSubmit.formData,r=!this.previewData.mch_list[t].integral.use;e.list[t].use_integral=r?1:0,this.previewData.mch_list[t].integral.use=r,this.loadPreviewData()},inputRemark:function(t){var e=this.$store.state.orderSubmit.formData;e.list[t].remark=this.previewData.mch_list[t].remark,this.$store.commit("orderSubmit/mutSetFormData",e)},submit:function(){var e=this;t.showLoading({mask:!0,title:"提交中"}),this.$request({url:this.submitUrl,method:"post",data:{form_data:JSON.stringify(this.$store.state.orderSubmit.formData)}}).then(function(r){0===r.code?e.getPayOrderId(r.data.queue_id,r.data.token):(e.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:r.msg,showCancel:!1}))}).catch(function(r){e.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:r.errMsg,showCancel:!1})})},getPayOrderId:function(e,r){var i=this;this.$request({url:this.payDataUrl,method:"post",data:{queue_id:e,token:r}}).then(function(a){0===a.code?a.data.retry&&1===a.data.retry?i.getPayDataTimer=setTimeout(function(){i.getPayOrderId(e,r)},1e3):(console.log(a),t.hideLoading(),i.pay(a.data)):(i.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:a.msg,showCancel:!1}))}).catch(function(e){i.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:e.errMsg,showCancel:!1})})},pay:function(e){var r=this;this.$payment.pay(e.id).then(function(i){if(console.log("支付成功",i),r.showPayResult)t.redirectTo({url:"/pages/order-submit/pay-result?payment_order_union_id=".concat(e.id,"&order_page_url=").concat(encodeURIComponent(r.orderPageUrl))});else{var a=r.orderPageUrl;-1===a.indexOf("?")?a+="?":a+="&",delete e.id,a+="pay_data=".concat(JSON.stringify(e)),t.redirectTo({url:a})}}).catch(function(i){if(console.log("支付失败",i),r.payCancelUrl){var a=r.payCancelUrl;-1===a.indexOf("?")?a+="?":a+="&",a+="pay_data=".concat(JSON.stringify(e)),t.redirectTo({url:a})}else t.showModal({title:"提交失败",content:i.errMsg,showCancel:!1,success:function(){t.redirectTo({url:r.orderPageUrl})}})})},jump:function(e){t.navigateTo({url:"/pages/order-submit/map"})},checkCouponError:function(){for(var e in this.previewData.mch_list)if(this.previewData.mch_list[e].coupon&&this.previewData.mch_list[e].coupon.coupon_error)return void t.showModal({title:"",content:this.previewData.mch_list[e].coupon.coupon_error,showCancel:!1})},setDiyFormScrollStatus:function(){for(var t in console.log("this.previewData.mch_list---\x3e",this.previewData.mch_list),this.previewData.mch_list)this.previewData.mch_list[t].order_form&&(this.previewData.mch_list[t].order_form.value&&this.previewData.mch_list[t].order_form.value.length&&this.previewData.mch_list[t].order_form.value.length>=5?this.previewData.mch_list[t].order_form.show_scroll=!0:this.previewData.mch_list[t].order_form.show_scroll=!1)},subscribe:function(){var e=this;for(var r in this.$store.state.orderSubmit.formData.list){var i=this.$store.state.orderSubmit.formData.list[r];if(i.order_form_validate_result&&i.order_form_validate_result.hasError)return void t.showModal({title:"提示",content:i.order_form_validate_result.errors[0].msg,showCancel:!1})}for(var a in this.$store.state.orderSubmit.formData.list)for(var o in this.$store.state.orderSubmit.formData.list[a].goods_list){var s=this.$store.state.orderSubmit.formData.list[a].goods_list[o];if(s.goods_form_validate_result&&s.goods_form_validate_result.hasError)return void t.showModal({title:"提示",content:s.goods_form_validate_result.errors[0].msg,showCancel:!1})}this.submitLock||(this.submitLock=!0,this.$subscribe(this.previewData.template_message_list).then(function(t){e.submit()}).catch(function(t){e.submit()}))},handleGoodsFormInput:function(t,e){var r=e.split(","),i=parseInt(r[0]),a=parseInt(r[1]),o=(parseInt(r[2]),[]);for(var s in t)o[s]={key:t[s].key,label:t[s].name,value:t[s].value,required:t[s].is_required};var n=this.$store.state.orderSubmit.formData;n.list[i].goods_list[a].form_data=o,this.$store.commit("orderSubmit/mutSetFormData",n)},handleGoodsFormValidate:function(t,e){var r=e.split(","),i=parseInt(r[0]),a=parseInt(r[1]),o=this.$store.state.orderSubmit.formData;o.list[i].goods_list[a].goods_form_validate_result=t,this.$store.commit("orderSubmit/mutSetFormData",o)}}};e.default=u}).call(this,r("c11b")["default"])},ad23:function(t,e,r){},c0e3:function(t,e,r){"use strict";r.r(e);var i=r("718c"),a=r.n(i);for(var o in i)"default"!==o&&function(t){r.d(e,t,function(){return i[t]})}(o);e["default"]=a.a},ff12:function(t,e,r){"use strict";var i=function(){var t=this,e=t.$createElement;t._self._c},a=[];r.d(e,"a",function(){return i}),r.d(e,"b",function(){return a})}},[["3d1c","common/runtime","common/vendor"]]]);